<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SplitBills - Easy Trip Expenses</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #388E3C;
            --secondary-color: #f0f0f0;
            --danger-color: #E53935;
            --warning-color: #FFC107;
            --text-color: #333;
            --text-light: #666;
            --bg-color: #f8f9fa;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0,0,0,0.07);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.6;
        }

        header {
            margin-bottom: 2.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }
        
        header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .container {
            width: 100%;
            max-width: 650px;
        }

        .card {
            background: #fff;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out forwards;
            opacity: 0;
            animation-delay: 0.2s;
        }

        .hidden { display: none !important; }

        #loading-state {
            text-align: center;
            font-size: 1.2rem;
            padding: 3rem;
            color: var(--text-light);
        }

        input, select, button, textarea {
            width: 100%;
            padding: 15px;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        h2, h3 {
            margin-top: 0;
            color: var(--primary-dark);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        p { color: var(--text-light); }

        #trip-title-display {
            text-align: center;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-weight: 600;
        }

        fieldset {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 1rem; margin-top: 1rem;
        }
        
        legend { font-weight: 600; padding: 0 0.5rem; }
        
        #split-between-container div, #edit-split-between-container div {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        input[type="checkbox"] {
            width: 1.2em; height: 1.2em; margin-right: 0.8rem;
        }

        ul { list-style: none; padding: 0; }

        li {
            padding: 1rem;
            border-bottom: 1px solid var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: background-color 0.2s;
        }
        li:hover { background-color: #fcfcfc; }
        li:last-child { border-bottom: none; }

        .description { font-weight: 600; }
        .details { font-size: 0.9em; color: var(--text-light); }
        .expense-info { flex-grow: 1; }
        .action-buttons { display: flex; gap: 10px; margin-left: 1rem; }

        .action-buttons button {
            padding: 6px 10px;
            font-size: 1rem;
            width: auto;
            border-radius: 8px;
        }
        .edit-btn { background: var(--warning-color); color: #333; }
        .delete-btn { background: var(--danger-color); }
        
        .summary-amount { font-weight: 700; color: var(--primary-dark); }

        .welcome-banner {
            text-align: center; margin-bottom: 2rem;
            font-size: 1.1em; background-color: #e8f5e9;
            padding: 1rem; border-radius: var(--border-radius);
        }

        #change-user-button {
            background: none; border: none; color: var(--primary-color);
            cursor: pointer; padding: 0; margin-left: 5px; font-size: 0.9em;
            width: auto; font-weight: 600; text-decoration: underline;
        }

        .user-selection-button { display: block; margin-bottom: 10px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: var(--border-radius);
            width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-buttons { display: flex; gap: 1rem; margin-top: 1rem; }
        .modal-buttons button { flex-grow: 1; }
        .modal-buttons .cancel-btn { background: #aaa; }
    </style>
</head>
<body>

    <header>
        <h1>üí∏ SplitBills</h1>
    </header>

    <main class="container">
        <div id="loading-state" class="hidden">Loading trip data...</div>

        <section id="setup-section" class="card">
            <h2>Create a New Trip</h2>
            <p>Sign in with Google to create a new shared expense sheet. All data is stored securely in your own Google Drive.</p>
            <button id="authorize-button" disabled>Loading Google Services...</button>
            <div id="participant-setup" class="hidden">
                <input type="text" id="trip-name" placeholder="Name of the trip (e.g., Miami Vacation)" required>
                <textarea id="participant-names" placeholder="Enter participant names, one per line..." required></textarea>
                <button id="create-trip-button">Create Trip Sheet</button>
            </div>
        </section>

        <section id="dashboard-section" class="hidden">
            <h2 id="trip-title-display"></h2>
            <div class="welcome-banner">
                <p>Viewing trip as: <strong id="current-user-name"></strong> <button id="change-user-button">(Change)</button></p>
            </div>
            
            <div id="summary-section" class="card">
                <h3>üìä Summary: Who Owes Who</h3>
                <ul id="summary-list"></ul>
            </div>
            
            <div id="expense-form-section" class="card">
                <h3>Add a New Expense</h3>
                <form id="add-expense-form">
                    <input type="text" id="expense-description" placeholder="Description (e.g., Dinner)" required>
                    <input type="number" id="expense-amount" placeholder="Amount ($)" step="0.01" min="0.01" required>
                    <label for="expense-payer">Paid by:</label>
                    <select id="expense-payer" required></select>
                    <fieldset>
                        <legend>Split between:</legend>
                        <div id="split-between-container"></div>
                    </fieldset>
                    <button type="submit">Add Expense</button>
                </form>
            </div>

            <div id="history-section" class="card">
                <h3>üìú Expense History</h3>
                <ul id="expense-list"></ul>
            </div>
        </section>
        
        <section id="user-selection-section" class="hidden card">
            <h2 id="user-selection-title"></h2>
            <p>To continue, please select your name from the list below.</p>
            <div id="user-list-container"></div>
        </section>

        <section id="login-prompt-section" class="hidden card">
            <h2 id="login-prompt-heading"></h2>
            <p id="login-prompt-text"></p>
            <button id="final-login-button">Sign In with Google</button>
        </section>
    </main>

    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Edit Expense</h3>
            <form id="edit-expense-form">
                <input type="hidden" id="edit-row-index">
                <input type="text" id="edit-expense-description" placeholder="Description" required>
                <input type="number" id="edit-expense-amount" placeholder="Amount ($)" step="0.01" min="0.01" required>
                <label for="edit-expense-payer">Paid by:</label>
                <select id="edit-expense-payer" required></select>
                <fieldset>
                    <legend>Split between:</legend>
                    <div id="edit-split-between-container"></div>
                </fieldset>
                <div class="modal-buttons">
                    <button type="button" id="cancel-edit-btn" class="cancel-btn">Cancel</button>
                    <button type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyAoT36fKenWKMTMornUsrDT49UZv8RuLxM'; // Replace with your actual API Key
        const CLIENT_ID = '339379248220-s92gtnetseqmdufpe2ea34jl5rtklic0.apps.googleusercontent.com'; // Replace with your actual Client ID

        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // --- GLOBAL STATE ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let spreadsheetId = null;

        // --- DOM ELEMENT CACHE ---
        const DOMElements = {
            setupSection: document.getElementById('setup-section'),
            dashboardSection: document.getElementById('dashboard-section'),
            userSelectionSection: document.getElementById('user-selection-section'),
            loginPromptSection: document.getElementById('login-prompt-section'),
            authorizeButton: document.getElementById('authorize-button'),
            createTripButton: document.getElementById('create-trip-button'),
            finalLoginButton: document.getElementById('final-login-button'),
            changeUserButton: document.getElementById('change-user-button'),
            participantSetupDiv: document.getElementById('participant-setup'),
            loadingState: document.getElementById('loading-state'),
            addExpenseForm: document.getElementById('add-expense-form'),
            editModal: document.getElementById('edit-modal'),
            editExpenseForm: document.getElementById('edit-expense-form'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            tripTitleDisplay: document.getElementById('trip-title-display'),
            currentUserDisplay: document.getElementById('current-user-name'),
        };

        // --- GOOGLE API INITIALIZATION ---
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
            checkApiInitState();
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' });
            gisInited = true;
            checkApiInitState();
        }
        function checkApiInitState() {
            if (gapiInited && gisInited) {
                DOMElements.authorizeButton.textContent = 'Sign In & Create Trip';
                DOMElements.authorizeButton.disabled = false;
                const params = new URLSearchParams(window.location.search);
                if (params.has('tripId')) {
                    spreadsheetId = params.get('tripId');
                    DOMElements.setupSection.classList.add('hidden');
                    loadTripData();
                }
            }
        }

        // --- AUTHENTICATION ---
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) return console.warn('Auth error:', resp.error);
                gapi.client.setToken(resp);
                if (spreadsheetId) await loadTripData();
                else {
                    DOMElements.participantSetupDiv.classList.remove('hidden');
                    DOMElements.authorizeButton.classList.add('hidden');
                }
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({ prompt: 'consent' });
            else tokenClient.requestAccessToken({ prompt: '' });
        }
        
        // --- TRIP CREATION ---
        async function handleCreateTrip() {
            DOMElements.createTripButton.disabled = true;
            DOMElements.createTripButton.textContent = 'Creating...';
            const tripName = document.getElementById('trip-name').value.trim();
            const namesText = document.getElementById('participant-names').value.trim();
            const participants = namesText.split('\n').map(name => name.trim()).filter(Boolean);

            if (!tripName || participants.length < 2) {
                alert('Please enter a trip name and at least two participant names, each on a new line.');
                DOMElements.createTripButton.disabled = false;
                DOMElements.createTripButton.textContent = 'Create Trip Sheet';
                return;
            }
            try {
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: { title: tripName },
                    sheets: [{ properties: { title: 'Participants' } }, { properties: { title: 'Expenses' } }]
                });
                spreadsheetId = response.result.spreadsheetId;
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId,
                    resource: {
                        valueInputOption: 'RAW',
                        data: [
                            { range: 'Expenses!A1:E1', values: [['ID', 'Description', 'Amount', 'Payer', 'SplitBetween']] },
                            { range: 'Participants!A1', values: participants.map(name => [name]) }
                        ]
                    }
                });

                // *** THE BUG FIX ***
                // Instead of trying to manually update the UI, we redirect to the new URL.
                // The page's existing loading logic will then handle displaying the dashboard correctly.
                localStorage.setItem(`currentUser_${spreadsheetId}`, participants[0]); // Set creator as default user
                const newUrl = `${window.location.origin}${window.location.pathname}?tripId=${spreadsheetId}`;
                window.location.href = newUrl; // Redirect to the newly created trip page

            } catch (err) {
                console.error("Error creating trip:", err);
                alert(`An error occurred: ${err.result?.error?.message || 'Unknown error'}`);
                DOMElements.createTripButton.disabled = false;
                DOMElements.createTripButton.textContent = 'Create Trip Sheet';
            }
        }
        
        // --- DATA LOADING & STATE MANAGEMENT ---
        async function loadTripData() {
            // Hide all sections, show loader
            [DOMElements.setupSection, DOMElements.dashboardSection, DOMElements.userSelectionSection, DOMElements.loginPromptSection].forEach(el => el.classList.add('hidden'));
            DOMElements.loadingState.classList.remove('hidden');
            
            try {
                const spreadsheetDetails = await gapi.client.sheets.spreadsheets.get({ spreadsheetId });
                const tripTitle = spreadsheetDetails.result.properties.title;
                DOMElements.tripTitleDisplay.textContent = tripTitle;
                
                const participants = await getParticipants();
                const currentUser = localStorage.getItem(`currentUser_${spreadsheetId}`);

                if (currentUser && participants.includes(currentUser)) {
                    await renderDashboard(participants, currentUser);
                } else {
                    showUserSelection(participants, tripTitle);
                }
            } catch (err) {
                console.warn("Authentication likely required:", err);
                DOMElements.loadingState.classList.add('hidden');
                document.getElementById('login-prompt-heading').textContent = `Welcome to this Trip!`;
                document.getElementById('login-prompt-text').textContent = "To view this shared expense sheet, please sign in with your Google account.";
                DOMElements.loginPromptSection.classList.remove('hidden');
            }
        }

        function showUserSelection(participants, tripTitle) {
            const container = document.getElementById('user-list-container');
            container.innerHTML = '';
            document.getElementById('user-selection-title').textContent = `Welcome to "${tripTitle}"`;
            participants.forEach(name => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = 'user-selection-button';
                button.onclick = () => selectUser(name);
                container.appendChild(button);
            });
            DOMElements.loadingState.classList.add('hidden');
            DOMElements.userSelectionSection.classList.remove('hidden');
        }

        async function selectUser(name) {
            localStorage.setItem(`currentUser_${spreadsheetId}`, name);
            await loadTripData();
        }

        function handleChangeUser() {
            localStorage.removeItem(`currentUser_${spreadsheetId}`);
            window.location.reload();
        }

        async function renderDashboard(participants, currentUser) {
            DOMElements.currentUserDisplay.textContent = currentUser;
            const payerSelect = document.getElementById('expense-payer');
            const splitContainer = document.getElementById('split-between-container');
            payerSelect.innerHTML = '';
            splitContainer.innerHTML = '';
            participants.forEach(name => {
                // Populate 'Paid by' dropdown
                const option = document.createElement('option');
                option.value = name; option.textContent = name;
                if (name === currentUser) option.selected = true;
                payerSelect.appendChild(option);
                // Populate 'Split between' checkboxes
                const checkboxDiv = document.createElement('div');
                checkboxDiv.innerHTML = `<input type="checkbox" id="split-${name}" value="${name}" checked><label for="split-${name}">${name}</label>`;
                splitContainer.appendChild(checkboxDiv);
            });
            await calculateAndDisplaySummary();
            DOMElements.loadingState.classList.add('hidden');
            DOMElements.dashboardSection.classList.remove('hidden');
        }
        
        // --- GOOGLE SHEETS API HELPERS ---
        async function getParticipants() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range: 'Participants!A:A' });
            return res.result.values ? res.result.values.flat() : [];
        }

        async function getExpenses() {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range: 'Expenses!A2:E' });
            if (!res.result.values) return [];
            return res.result.values
                .map((row, index) => ({
                    id: row[0], description: row[1], amount: parseFloat(row[2]), payer: row[3],
                    splitBetween: row[4] ? row[4].split(',') : [], rowIndex: index + 2
                }))
                .filter(exp => exp.id && exp.description);
        }

        // --- EXPENSE MANAGEMENT (ADD, EDIT, DELETE) ---
        async function handleAddExpense(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payer = document.getElementById('expense-payer').value;
            const splitCheckboxes = document.querySelectorAll('#split-between-container input[type="checkbox"]:checked');
            const splitBetween = Array.from(splitCheckboxes).map(cb => cb.value);

            if (!description || isNaN(amount) || amount <= 0 || !payer || splitBetween.length === 0) {
                alert('Please fill out all fields correctly.');
                submitButton.disabled = false; return;
            }
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId, range: 'Expenses!A:E', valueInputOption: 'USER-ENTERED',
                    resource: { values: [[new Date().getTime(), description, amount, payer, splitBetween.join(',')]] },
                });
                DOMElements.addExpenseForm.reset();
                document.getElementById('expense-payer').value = localStorage.getItem(`currentUser_${spreadsheetId}`);
                document.querySelectorAll('#split-between-container input[type="checkbox"]').forEach(cb => cb.checked = true);
                await calculateAndDisplaySummary();
            } catch(err) {
                console.error("Error adding expense:", err);
                alert('Could not add expense.');
            } finally {
                submitButton.disabled = false;
            }
        }
        
        async function handleDeleteExpense(rowIndex) {
            if (!confirm('Are you sure you want to delete this expense? This action cannot be undone.')) return;
            try {
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId, range: `Expenses!A${rowIndex}:E${rowIndex}`,
                });
                await calculateAndDisplaySummary();
            } catch (err) {
                console.error('Error deleting expense:', err);
                alert('Could not delete the expense.');
            }
        }
        
        function openEditModal(expense, participants) {
            document.getElementById('edit-row-index').value = expense.rowIndex;
            document.getElementById('edit-expense-description').value = expense.description;
            document.getElementById('edit-expense-amount').value = expense.amount.toFixed(2);
            const payerSelect = document.getElementById('edit-expense-payer');
            const splitContainer = document.getElementById('edit-split-between-container');
            payerSelect.innerHTML = ''; splitContainer.innerHTML = '';
            participants.forEach(name => {
                const option = document.createElement('option');
                option.value = name; option.textContent = name;
                if (name === expense.payer) option.selected = true;
                payerSelect.appendChild(option);
                const isChecked = expense.splitBetween.includes(name);
                const checkboxDiv = document.createElement('div');
                checkboxDiv.innerHTML = `<input type="checkbox" id="edit-split-${name}" value="${name}" ${isChecked ? 'checked' : ''}><label for="edit-split-${name}">${name}</label>`;
                splitContainer.appendChild(checkboxDiv);
            });
            DOMElements.editModal.classList.remove('hidden');
        }

        async function handleUpdateExpense(event) {
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            const rowIndex = document.getElementById('edit-row-index').value;
            const description = document.getElementById('edit-expense-description').value;
            const amount = parseFloat(document.getElementById('edit-expense-amount').value);
            const payer = document.getElementById('edit-expense-payer').value;
            const splitBetween = Array.from(document.querySelectorAll('#edit-split-between-container input:checked')).map(cb => cb.value);

            if (!description || isNaN(amount) || amount <= 0 || !payer || splitBetween.length === 0) {
                alert('Please fill out all fields correctly.');
                submitButton.disabled = false; return;
            }
            const expenses = await getExpenses();
            const originalExpense = expenses.find(e => e.rowIndex == rowIndex);
            if (!originalExpense) { alert('Could not find original expense to update.'); submitButton.disabled = false; return; }
            const updatedValues = [originalExpense.id, description, amount, payer, splitBetween.join(',')];
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId, range: `Expenses!A${rowIndex}:E${rowIndex}`,
                    valueInputOption: 'USER-ENTERED',
                    resource: { values: [updatedValues] }
                });
                DOMElements.editModal.classList.add('hidden');
                await calculateAndDisplaySummary();
            } catch (err) {
                console.error('Error updating expense:', err);
                alert('Could not update the expense.');
            } finally {
                submitButton.disabled = false;
            }
        }
        
        // --- SUMMARY & DISPLAY LOGIC ---
        async function calculateAndDisplaySummary() {
            const [participants, expenses] = await Promise.all([getParticipants(), getExpenses()]);
            const expenseListUl = document.getElementById('expense-list');
            const summaryListUl = document.getElementById('summary-list');
            expenseListUl.innerHTML = ''; summaryListUl.innerHTML = '';
            const currentUser = localStorage.getItem(`currentUser_${spreadsheetId}`);

            if (expenses.length === 0) {
                expenseListUl.innerHTML = '<li>No expenses added yet. Be the first!</li>';
            } else {
                expenses.slice().reverse().forEach(exp => {
                    const li = document.createElement('li');
                    let actionButtons = '';
                    if (exp.payer === currentUser) {
                        actionButtons = `<div class="action-buttons">
                            <button class="edit-btn" title="Edit">‚úèÔ∏è</button>
                            <button class="delete-btn" title="Delete">üóëÔ∏è</button>
                        </div>`;
                    }
                    li.innerHTML = `<div class="expense-info">
                            <div class="description">${exp.description}</div>
                            <div class="details">Paid by ${exp.payer} - $${exp.amount.toFixed(2)}</div>
                        </div>
                        ${actionButtons}`;
                    if (li.querySelector('.edit-btn')) li.querySelector('.edit-btn').onclick = () => openEditModal(exp, participants);
                    if (li.querySelector('.delete-btn')) li.querySelector('.delete-btn').onclick = () => handleDeleteExpense(exp.rowIndex);
                    expenseListUl.appendChild(li);
                });
            }

            const balances = participants.reduce((acc, p) => ({ ...acc, [p]: 0 }), {});
            expenses.forEach(exp => {
                if(balances[exp.payer] !== undefined) balances[exp.payer] += exp.amount;
                const share = exp.amount / exp.splitBetween.length;
                exp.splitBetween.forEach(person => {
                    if(balances[person] !== undefined) balances[person] -= share;
                });
            });

            const debtors = Object.entries(balances).filter(([, amt]) => amt < -0.01).map(([name, amount]) => ({ name, amount: -amount }));
            const creditors = Object.entries(balances).filter(([, amt]) => amt > 0.01).map(([name, amount]) => ({ name, amount }));
            const transactions = [];
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0], creditor = creditors[0];
                const amount = Math.min(debtor.amount, creditor.amount);
                transactions.push(`<li>${debtor.name} owes ${creditor.name} <span class="summary-amount">$${amount.toFixed(2)}</span></li>`);
                debtor.amount -= amount; creditor.amount -= amount;
                if (debtor.amount < 0.01) debtors.shift();
                if (creditor.amount < 0.01) creditors.shift();
            }
            summaryListUl.innerHTML = transactions.length > 0 ? transactions.join('') : '<li>Everyone is settled up! üéâ</li>';
        }

        // --- EVENT LISTENERS ---
        DOMElements.authorizeButton.onclick = handleAuthClick;
        DOMElements.createTripButton.onclick = handleCreateTrip;
        DOMElements.finalLoginButton.onclick = handleAuthClick;
        DOMElements.addExpenseForm.onsubmit = handleAddExpense;
        DOMElements.editExpenseForm.onsubmit = handleUpdateExpense;
        DOMElements.cancelEditBtn.onclick = () => DOMElements.editModal.classList.add('hidden');
        DOMElements.changeUserButton.onclick = handleChangeUser;
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
